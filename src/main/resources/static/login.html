<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - 双虎人力资源管理系统</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* 保持原有样式不变 */
        body { margin: 0; padding: 0; height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%); font-family: "Microsoft YaHei", sans-serif; }
        .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        .title { color: #333; margin-bottom: 10px; font-size: 24px; font-weight: bold; }
        .subtitle { color: #888; font-size: 14px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; color: #555; font-size: 14px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: #8ec5fc; box-shadow: 0 0 5px rgba(142, 197, 252, 0.5); }
        .btn-login { width: 100%; padding: 12px; background-color: #4facfe; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn-login:hover { background-color: #00f2fe; }
        .btn-login:disabled { background-color: #ccc; cursor: not-allowed; }
        .error-msg { color: #ff4d4f; font-size: 13px; margin-top: 10px; min-height: 20px; }
    </style>
</head>
<body>

<div id="app">
    <div class="login-card">
        <div class="title">双虎人事管理系统</div>
        <div class="subtitle">Shuanghu Personnel Management System</div>

        <div class="form-group">
            <label>用户名 / 工号</label>
            <input type="text" v-model="form.username" class="input-field" placeholder="请输入用户名">
        </div>

        <div class="form-group">
            <label>密码</label>
            <input type="password" v-model="form.password" class="input-field" placeholder="请输入密码">
        </div>

        <div class="form-group">
            <label>登录身份</label>
            <select v-model="form.role" class="input-field">
                <option disabled value="">请选择您的身份</option>
                <option value="employee">普通员工</option>
                <option value="manager">管理人员</option>
                <option value="admin">超级用户</option>
                <option value="visitor">访客</option>
            </select>
        </div>

        <button class="btn-login" @click="handleLogin" :disabled="loading">
            {{ loading ? '登录中...' : '登 录' }}
        </button>

        <div class="error-msg">{{ message }}</div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, onMounted } = Vue;

    createApp({
        setup() {
            const form = reactive({
                username: '',
                password: '',
                role: ''
            });

            const loading = ref(false);
            const message = ref('');
            const wrongPwdCount = ref(0); // 密码错误计数

            // Cookie 操作
            const setCookie = (name, value, days = 7) => {
                const exp = new Date();
                exp.setTime(exp.getTime() + days * 24 * 60 * 60 * 1000);
                document.cookie = `${name}=${encodeURIComponent(value)};expires=${exp.toUTCString()};path=/`;
            };

            const getCookie = (name) => {
                const reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
                const arr = document.cookie.match(reg);
                return arr ? decodeURIComponent(arr[2]) : null;
            };

            onMounted(() => {
                const savedUser = getCookie("username");
                const savedRole = getCookie("role");
                if (savedUser && savedRole) {
                    form.username = savedUser;
                    form.role = savedRole;
                    // 密码通常不建议自动填充太明显，但为了用户体验可保留
                    const savedPwd = getCookie("password");
                    if(savedPwd) form.password = savedPwd;
                }
            });

            const handleLogin = () => {
                if (!form.username || !form.password || !form.role) {
                    message.value = "请填写完整的登录信息";
                    return;
                }

                loading.value = true;
                message.value = "正在验证...";

                // 构建表单参数
                const params = new URLSearchParams();
                params.append('username', form.username);
                params.append('password', form.password);
                params.append('role', form.role);

                // 发送请求到后端 LoginServlet
                fetch('api/login', {
                    method: 'POST',
                    body: params
                })
                    .then(res => res.json())
                    .then(data => {
                        loading.value = false;

                        if (data.success) {
                            message.value = "登录成功！正在跳转...";
                            wrongPwdCount.value = 0;

                            // 记住密码
                            setCookie("username", form.username);
                            setCookie("password", form.password);
                            setCookie("role", form.role);

                            // 跳转
                            setTimeout(() => {
                                window.location.href = "dept_manage_final_fixed.html"; // 请根据实际首页名称调整
                            }, 800);

                        } else {
                            // 登录失败处理
                            message.value = data.message;

                            if(data.message.includes("密码错误")) {
                                wrongPwdCount.value++;
                                if (wrongPwdCount.value >= 3) {
                                    alert("⚠️ 密码错误次数过多，请稍后再试！");
                                    // 这里可以做锁定逻辑，目前仅弹窗
                                }
                            } else if(data.message.includes("用户名不存在")) {
                                // 只有用户名不存在时，才提示去注册（可选）
                                if(confirm("用户名不存在，是否前往注册？")) {
                                    window.location.href = "register.html";
                                }
                            }
                        }
                    })
                    .catch(err => {
                        loading.value = false;
                        message.value = "服务器连接失败，请检查网络";
                        console.error(err);
                    });
            };

            return {
                form,
                loading,
                message,
                handleLogin
            };
        }
    }).mount('#app');
</script>
</body>
</html>