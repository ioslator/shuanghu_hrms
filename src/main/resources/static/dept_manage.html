<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>双虎人事管理系统 - 部门管理</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        /* 1. 基础布局和背景 (沿用登录/注册风格) */
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
            font-family: "Microsoft YaHei", sans-serif;
        }

        /* 2. 主容器和卡片样式 */
        #deptApp {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 500px; /* 略宽一些以容纳管理内容 */
            text-align: left;
        }

        /* 标题样式 */
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        /* 3. 表单元素通用样式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: inline-block;
            width: 100px; /* 标签固定宽度 */
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
            text-align: right;
            padding-right: 15px;
        }

        .input-field, select {
            width: calc(100% - 130px); /* 减去 label 宽度和内边距 */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
            display: inline-block;
        }

        .input-field:focus, select:focus {
            border-color: #4facfe;
            box-shadow: 0 0 5px rgba(79, 172, 254, 0.3);
        }

        /* 4. 按钮样式 */
        .btn-base {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: 0.3s;
            margin-left: 10px;
        }

        .btn-primary {
            background-color: #4facfe; /* 蓝色 */
        }
        .btn-primary:hover {
            background-color: #00f2fe;
        }

        .btn-danger {
            background-color: #f56c6c; /* 红色 */
        }
        .btn-danger:hover {
            background-color: #e62f2f;
        }

        /* 5. 顶部操作区样式 */
        .top-controls {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .top-controls select {
            width: 250px;
            margin-right: 15px;
        }

        /* 6. 表单按钮对齐 */
        .form-actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
<div id="deptApp">
    <h2>部门信息管理</h2>

    <div class="top-controls">
        <label>
            <select v-model="selectedDeptId" @change="loadDeptDetail" class="input-field">
                <option value="">请选择部门 (进行编辑或删除)</option>
                <option v-for="dept in deptList" :value="dept.dept_id">{{dept.dept_name}}</option>
            </select>
        </label>

        <button @click="deleteDept" :disabled="!selectedDeptId" class="btn-base btn-danger">
            删除选中部门
        </button>
    </div>

    <form id="deptForm">
        <div class="form-group">
            <label>部门ID:</label>
            <input type="text" :value="deptData.dept_id || '新增'" disabled class="input-field" style="background-color: #f7f7f7;">
        </div>

        <div class="form-group">
            <label>部门名称:</label>
            <input type="text" name="dept_name" v-model="deptData.dept_name" class="input-field" placeholder="请输入部门名称">
        </div>

        <div class="form-group">
            <label>父部门ID:</label>
            <input type="number" name="dept_parent_id" v-model="deptData.dept_parent_id" class="input-field" placeholder="请输入父部门ID (0为顶级)">
        </div>

        <div class="form-group">
            <label>状态:</label>
            <select name="dept_status" v-model="deptData.dept_status" class="input-field">
                <option :value="1">启用</option>
                <option :value="0">停用</option>
            </select>
        </div>

        <div class="form-actions">
            <button type="button" @click="saveDept" class="btn-base btn-primary">
                {{ deptData.dept_id ? '更新' : '新增' }} 部门
            </button>
        </div>
    </form>
</div>

<script>
    new Vue({
        el: "#deptApp",
        data: {
            deptList: [],
            selectedDeptId: "",
            deptData: {
                dept_id: "",
                dept_name: "",
                dept_parent_id: "",
                dept_status: 1
            }
        },
        mounted() {
            this.loadDeptList();
        },
        methods: {
            // Vue逻辑保持不变
            loadDeptList() {
                const params = new URLSearchParams();
                params.append('tableName', 'dept');
                params.append('keyName', 'dept_id,dept_name');

                // 强制写死完整地址 + 加上时间戳防缓存
                axios.post("/getCol?t=" + new Date().getTime(), params, {
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                }).then(res => {
                    console.log("部门列表加载成功：", res.data);
                    this.deptList = res.data || [];
                }).catch(err => {
                    console.error("加载失败", err);
                    alert("真的连不上了！检查控制台 Network 标签");
                });
            },

            loadDeptDetail() {
                if (!this.selectedDeptId) {
                    // 如果取消选择，清空表单以便新增
                    this.deptData = { dept_id: "", dept_name: "", dept_parent_id: "", dept_status: 1 };
                    return;
                }
                const params = new URLSearchParams();
                params.append('tableName', 'dept');
                params.append('keyName', 'dept_id');
                params.append('keyValue', this.selectedDeptId);

                axios.post("/getCols", params, {
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                }).then(res => {
                    if (res.data && res.data.length > 0) {
                        // 【关键修改开始】手动将所有键名转为小写，防止大小写不匹配问题
                        let rawData = res.data[0];
                        let lowerData = {};
                        for (let key in rawData) {
                            lowerData[key.toLowerCase()] = rawData[key];
                        }
                        this.deptData = lowerData;
                        // 【关键修改结束】

                        console.log("处理后的部门数据：", JSON.stringify(this.deptData)); // 方便在控制台查看
                    }
                }).catch(err => {
                    console.error("加载详情失败", err);
                    alert("加载部门详情失败");
                });
            },

            deleteDept() {
                if (!this.selectedDeptId || !confirm("确定删除？请注意：删除部门可能会影响员工数据的完整性！")) return;
                const params = new URLSearchParams();
                params.append('tableName', 'dept');
                params.append('keyName', 'dept_id');
                params.append('keyValue', this.selectedDeptId);

                axios.post("/delData", params, {
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                }).then(() => {
                    alert("删除成功");
                    this.selectedDeptId = "";
                    this.deptData = { dept_id: "", dept_name: "", dept_parent_id: "", dept_status: 1 }; // 清空表单
                    this.loadDeptList();
                }).catch(err => {
                    console.error("删除失败", err);
                    alert("删除失败，可能该部门下还有员工数据，请先转移或删除员工！");
                });
            },

            saveDept() {
                if (!this.deptData.dept_name?.trim()) return alert("部门名称不能为空");
                // 确保父部门ID是数字或可接受的空值
                if (this.deptData.dept_parent_id === null || this.deptData.dept_parent_id === undefined || this.deptData.dept_parent_id === "") {
                    this.deptData.dept_parent_id = 0;
                }

                const url = this.deptData.dept_id ? "/updateDept" : "/InsertDept";
                const fd = new FormData();
                fd.append('dept_name', this.deptData.dept_name);
                fd.append('dept_parent_id', this.deptData.dept_parent_id);
                fd.append('dept_status', this.deptData.dept_status);
                if (this.deptData.dept_id) fd.append('dept_id', this.deptData.dept_id);

                axios.post(url, fd).then(() => {
                    alert("保存成功");
                    this.loadDeptList();
                    if (!this.deptData.dept_id) {
                        // 新增成功后清空表单
                        this.deptData = { dept_id: "", dept_name: "", dept_parent_id: "", dept_status: 1 };
                        this.selectedDeptId = "";
                    }
                }).catch(err => {
                    console.error(err);
                    alert("保存失败，请检查数据格式或后端服务！");
                });
            }
        }
    });
</script>
</body>
</html>