<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>请假管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <style>
        body{padding:20px;background:#f8f9fa;}
        .status-pending { color: #856404; background-color: #fff3cd; }
        .status-approved { color: #155724; background-color: #d4edda; }
        .status-rejected { color: #721c24; background-color: #f8d7da; }
        
        /* 自定义模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.3rem;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        
        .modal-body {
            padding: 1rem 0;
        }
        
        .modal-footer {
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
            text-align: right;
        }
        
        .btn {
            display: inline-block;
            font-weight: 400;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        
        .btn-secondary {
            color: #fff;
            background-color: #6c757d;
            border-color: #6c757d;
        }
        
        .btn-success {
            color: #fff;
            background-color: #28a745;
            border-color: #28a745;
        }
        
        .btn-danger {
            color: #fff;
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">请假申请记录</h4>
        <div class="form-inline">
            <select class="form-control form-control-sm mr-2" id="statusFilter">
                <option value="">全部状态</option>
                <option value="pending">待审批</option>
                <option value="approved">已批准</option>
                <option value="rejected">已拒绝</option>
            </select>
            <button class="btn btn-primary btn-sm" onclick="refreshData()">刷新</button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th>申请人</th>
                        <th>类型</th>
                        <th>开始日期</th>
                        <th>结束日期</th>
                        <th>原因</th>
                        <th>联系方式</th>
                        <th>申请时间</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="list"></tbody>
            </table>
        </div>
    </div>
    
    <!-- 审批模态框 -->
    <div class="modal" id="approveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">请假审批</h5>
                <span class="close" onclick="closeApproveModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="approveAppId">
                <p>确定要批准此请假申请吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeApproveModal()">取消</button>
                <button type="button" class="btn btn-success" onclick="approveLeave('approved')">批准</button>
                <button type="button" class="btn btn-danger" onclick="approveLeave('rejected')">拒绝</button>
            </div>
        </div>
    </div>
</div>

<script>
    const typeMap = {
        1: {name: '事假', class: 'info'},
        2: {name: '病假', class: 'warning'}, 
        3: {name: '年假', class: 'success'},
        4: {name: '调休假', class: 'primary'},
        5: {name: '婚假', class: 'secondary'},
        6: {name: '产假', class: 'light'}
    };
    
    const statusMap = {
        pending: {name: '待审批', class: 'status-pending'},
        approved: {name: '已批准', class: 'status-approved'},
        rejected: {name: '已拒绝', class: 'status-rejected'}
    };
    
    function loadLeavesData() {
        // 从API获取真实数据
        fetch('api/leaves')
            .then(r => r.json())
            .then(data => {
                renderTable(data);
            })
            .catch(e => {
                console.error('获取数据失败:', e);
                document.getElementById('list').innerHTML = '<tr><td colspan="8" class="text-center text-danger">获取数据失败，请检查网络连接</td></tr>';
            });
    }
    
    function renderTable(data) {
        const filterStatus = document.getElementById('statusFilter').value;
        const filteredData = filterStatus ? data.filter(item => item.status === filterStatus) : data;
        
        if (filteredData.length === 0) {
            document.getElementById('list').innerHTML = '<tr><td colspan="8" class="text-center">暂无请假记录</td></tr>';
            return;
        }
        
        const html = filteredData.map(item => {
            const startDate = item.start_date ? new Date(item.start_date).toLocaleDateString() : '-';
            const endDate = item.end_date ? new Date(item.end_date).toLocaleDateString() : '-';
            const applyTime = item.apply_time ? new Date(item.apply_time).toLocaleString() : '-';
            
            // 只有待审批状态的申请才显示操作按钮
            const actionButtons = item.status === 'pending' ? 
                `<button class="btn btn-sm btn-success mr-1" onclick="openApproveModal(${item.application_id}, 'approved')">批准</button>
                 <button class="btn btn-sm btn-danger" onclick="openApproveModal(${item.application_id}, 'rejected')">拒绝</button>` :
                '-';
            
            return `
                <tr>
                    <td>${item.emp_name || '未知'}</td>
                    <td><span class="badge badge-${typeMap[item.leave_type]?.class || 'secondary'}">${typeMap[item.leave_type]?.name || item.leave_type || item.type || '未知'}</span></td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td title="${item.leave_reason || ''}">${(item.leave_reason || '').length > 20 ? (item.leave_reason || '').substring(0, 20) + '...' : item.leave_reason || '-'}</td>
                    <td>${item.contact_info || '-'}</td>
                    <td>${applyTime}</td>
                    <td><span class="badge ${statusMap[item.status]?.class || 'secondary'}">${statusMap[item.status]?.name || item.status}</span></td>
                    <td>${actionButtons}</td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('list').innerHTML = html;
    }
    
    function refreshData() {
        loadLeavesData();
    }
    
    // 状态筛选
    document.getElementById('statusFilter').addEventListener('change', loadLeavesData);
    
    // 页面加载时获取数据
    document.addEventListener('DOMContentLoaded', loadLeavesData);
    
    // 每30秒自动刷新数据
    setInterval(loadLeavesData, 30000);
    
    // 打开审批模态框
    function openApproveModal(appId, action) {
        document.getElementById('approveAppId').value = appId;
        document.getElementById('approveModal').style.display = 'block';
    }
    
    // 关闭审批模态框
    function closeApproveModal() {
        document.getElementById('approveModal').style.display = 'none';
    }
    
    // 点击模态框外部关闭模态框
    window.onclick = function(event) {
        const modal = document.getElementById('approveModal');
        if (event.target === modal) {
            closeApproveModal();
        }
    }
    
    // 执行审批操作
    function approveLeave(status) {
        const appId = document.getElementById('approveAppId').value;
        if (!appId) {
            alert('无效的申请ID');
            return;
        }
        
        // 构造表单数据
        const formData = new FormData();
        formData.append('appId', appId);
        formData.append('status', status);
        // 实际应用中应从session获取管理员ID
        formData.append('approveBy', '1');
        
        console.log('Sending approval request with:', {appId, status});
        
        // 发送PUT请求进行审批
        fetch('api/leaves', {
            method: 'PUT',
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Approval response:', data);
            if (data.success) {
                alert(data.message);
                closeApproveModal();
                // 刷新数据
                loadLeavesData();
            } else {
                alert('审批失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('审批请求失败:', error);
            alert('网络错误，请稍后重试');
        });
    }
</script>
</body>
</html>