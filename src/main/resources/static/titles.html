<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>职称管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <style>
        body{padding:20px;background:#f8f9fa;}
        .range-container { margin-top: 10px; }
        /* 简单的滑条样式调整 */
        input[type=range] { width: 100%; margin: 5px 0; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="d-flex justify-content-between mb-3">
        <h4>职称管理</h4>
        <button class="btn btn-primary btn-sm" onclick="openEditModal()">修改薪资范围</button>
    </div>
    <div class="card"><div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="bg-light"><tr><th>ID</th><th>职称名称</th><th>等级</th><th>薪资范围</th></tr></thead>
            <tbody id="list"></tbody>
        </table>
    </div></div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">修改薪资范围</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>选择职称</label>
                    <select id="titleSelect" class="form-control" onchange="loadRange()"></select>
                </div>
                <div class="form-group">
                    <label>薪资范围设定</label>
                    <div class="input-group mb-2">
                        <div class="input-group-prepend"><span class="input-group-text">Min</span></div>
                        <input type="number" id="minInput" class="form-control" oninput="syncSlider('min')">
                        <div class="input-group-prepend input-group-append"><span class="input-group-text">-</span></div>
                        <div class="input-group-prepend"><span class="input-group-text">Max</span></div>
                        <input type="number" id="maxInput" class="form-control" oninput="syncSlider('max')">
                    </div>
                    <div class="range-container">
                        <small class="text-muted">拖动滑条快速调整:</small>
                        <input type="range" id="minSlider" min="0" max="50000" step="100" oninput="syncInput('min')">
                        <input type="range" id="maxSlider" min="0" max="50000" step="100" oninput="syncInput('max')">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveData()">保存修改</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let allTitles = [];

    // 加载列表数据
    function loadList() {
        fetch('api/titles').then(r=>r.json()).then(data=>{
            allTitles = data; // 保存数据供弹窗使用
            const html = data.map(i=>`<tr><td>${i.title_id}</td><td>${i.title_name}</td><td>${i.title_level}</td><td>${i.title_salary_range}</td></tr>`).join('');
            document.getElementById('list').innerHTML = html || '<tr><td colspan="4" class="text-center">暂无数据</td></tr>';
        });
    }

    // 打开模态框
    function openEditModal() {
        const sel = document.getElementById('titleSelect');
        // 填充下拉框
        sel.innerHTML = allTitles.map(t => `<option value="${t.title_id}">${t.title_name}</option>`).join('');

        if(allTitles.length > 0) {
            loadRange(); // 加载第一个选项的数据
        }
        $('#editModal').modal('show');
    }

    // 根据选择的职称加载薪资数据
    function loadRange() {
        const id = document.getElementById('titleSelect').value;
        const title = allTitles.find(t => t.title_id == id);
        if (title) {
            // 假设数据库存的是 "3000-5000" 这种格式，尝试解析数字
            // 使用正则提取所有数字
            const nums = title.title_salary_range.match(/(\d+)/g);
            if (nums && nums.length >= 2) {
                updateUI(nums[0], nums[1]);
            } else {
                // 如果格式不对，给个默认值
                updateUI(0, 10000);
            }
        }
    }

    function updateUI(min, max) {
        document.getElementById('minInput').value = min;
        document.getElementById('maxInput').value = max;
        document.getElementById('minSlider').value = min;
        document.getElementById('maxSlider').value = max;
    }

    // 滑条 -> 输入框
    function syncInput(type) {
        const val = document.getElementById(type + 'Slider').value;
        document.getElementById(type + 'Input').value = val;
    }

    // 输入框 -> 滑条
    function syncSlider(type) {
        const val = document.getElementById(type + 'Input').value;
        document.getElementById(type + 'Slider').value = val;
    }

    // 保存数据
    function saveData() {
        const id = document.getElementById('titleSelect').value;
        const min = document.getElementById('minInput').value;
        const max = document.getElementById('maxInput').value;

        // 简单的验证
        if(parseInt(min) > parseInt(max)) {
            alert("最低薪资不能高于最高薪资！");
            return;
        }

        const range = `${min}-${max}`;

        fetch('api/titles', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `id=${id}&range=${range}`
        }).then(r=>r.json()).then(res=>{
            if(res.success) {
                alert('修改成功');
                $('#editModal').modal('hide');
                loadList(); // 刷新列表
            } else {
                alert('修改失败: ' + res.message);
            }
        });
    }

    // 初始化
    loadList();
</script>
</body>
</html>